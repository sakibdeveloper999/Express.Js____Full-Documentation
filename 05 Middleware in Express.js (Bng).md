
---

## ЁЯза 1я╕ПтГг Middleware ржХрзА (рж╕рж╣ржЬ рж╕ржВржЬрзНржЮрж╛)

**Express.js**-ржП
**Middleware** ржорж╛ржирзЗ рж╣рж▓рзЛ тАФ
тЮбя╕П тАЬржПржоржи ржХрж┐ржЫрзБ ржлрж╛ржВрж╢ржи ржпрж╛ ржХрзНрж▓рж╛рзЯрзЗржирзНржЯрзЗрж░ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ (Request) ржПржмржВ рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ рж░рзЗрж╕ржкржирзНрж╕ (Response)-ржПрж░ ржорж╛ржЭрзЗ ржХрж╛ржЬ ржХрж░рзЗредтАЭ

ржПржЗ ржлрж╛ржВрж╢ржиржЧрзБрж▓рзЛ ржкрж╛рж░рзЗ:

* `req` (request object) ржПржмржВ `res` (response object) ржкрж░рж┐ржмрж░рзНрждржи ржмрж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗред
* ржпрзЗржХрзЛржирзЛ ржХрзЛржб ржЪрж╛рж▓рж╛рждрзЗ (ржпрзЗржоржи рж▓ржЧ ржХрж░рж╛, ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛, ржЕржерзЗржиржЯрж┐ржХрзЗрж╢ржи ржЗрждрзНржпрж╛ржжрж┐)ред
* рж╕рж░рж╛рж╕рж░рж┐ рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛ржарж┐рзЯрзЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯтАУрж░рзЗрж╕ржкржирзНрж╕ рж╕рж╛ржЗржХрзЗрж▓ рж╢рзЗрж╖ ржХрж░рждрзЗред
* ржЕржержмрж╛ `next()` ржХрж▓ ржХрж░рзЗ ржкрж░ржмрж░рзНрждрзА middleware-ржП ржпрзЗрждрзЗред

---

## тЪЩя╕П 2я╕ПтГг Middleware ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ (ржнрж┐рждрж░рзЗрж░ рж▓ржЬрж┐ржХ)

ржпржЦржи ржХрзЛржирзЛ ржХрзНрж▓рж╛рзЯрзЗржирзНржЯ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛рзЯ тЖТ Express ржПржЯрж╛ ржПржоржиржнрж╛ржмрзЗ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзЗ ЁЯСЗ

```
Client тЖТ [Middleware 1] тЖТ [Middleware 2] тЖТ [Middleware 3] тЖТ Route Handler тЖТ Response
```

ржкрзНрж░рждрж┐ржЯрж┐ Middleware ржкрж╛рзЯ рждрж┐ржиржЯрж┐ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░:

```js
(req, res, next)
```

* **req:** ржХрзНрж▓рж╛рзЯрзЗржирзНржЯ ржерзЗржХрзЗ ржЖрж╕рж╛ ржбрзЗржЯрж╛ (headers, params, body ржЗрждрзНржпрж╛ржжрж┐)
* **res:** рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛ржарж╛ржирзЛрж░ ржЕржмржЬрзЗржХрзНржЯ
* **next:** ржкрж░ржмрж░рзНрждрзА middleware ржмрж╛ рж░рж╛ржЙржЯ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░рзЗ ржпрж╛ржУрзЯрж╛рж░ ржЬржирзНржп ржлрж╛ржВрж╢ржи

ЁЯСЙ ржпржжрж┐ рждрзБржорж┐ `next()` ржирж╛ рж▓рзЗржЦрзЛ, рждрж╛рж╣рж▓рзЗ ржПржЦрж╛ржирзЗржЗ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржерзЗржорзЗ ржпрж╛ржмрзЗред

---

## ЁЯзй 3я╕ПтГг Middleware ржлрж╛ржВрж╢ржирзЗрж░ ржорзМрж▓рж┐ржХ ржХрж╛ржарж╛ржорзЛ

```js
function middlewareName(req, res, next) {
  console.log('Middleware ржЪрж▓ржЫрзЗ...');
  next(); // ржкрж░рзЗрж░ middleware ржП ржпрж╛ржмрзЗ
}
```

**app-ржП ржмрзНржпржмрж╣рж╛рж░ (рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░) ржХрж░рж╛:**

```js
const express = require('express');
const app = express();

app.use(middlewareName); // ржЧрзНрж▓рзЛржмрж╛рж▓рж┐ ржкрзНрж░рзЯрзЛржЧ ржХрж░рж╛
```

---

## ЁЯз▒ 4я╕ПтГг Express.js ржП Middleware-ржПрж░ ржзрж░ржи

Express-ржП рж╕рж╛ржзрж╛рж░ржгржд рзл ржзрж░ржирзЗрж░ Middleware ржерж╛ржХрзЗ ЁЯСЗ

| ржзрж░ржи                   | ржХрж╛ржЬ                                | ржЙржжрж╛рж╣рж░ржг                  |
| --------------------- | ---------------------------------- | ----------------------- |
| **Application-level** | ржкрзБрж░рзЛ ржЕрзНржпрж╛ржкрзЗ ржмрж╛ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж░рж╛ржЙржЯрзЗ ржЪрж▓рзЗ | `app.use()`             |
| **Router-level**      | ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж░рж╛ржЙржЯрж╛рж░ ржлрж╛ржЗрж▓рзЗрж░ ржЬржирзНржп       | `router.use()`          |
| **Built-in**          | Express ржПрж░ рж╕рж╛ржерзЗ ржмрж┐рж▓рзНржЯ-ржЗржи ржЖрж╕рзЗ       | `express.json()`        |
| **Third-party**       | npm ржерзЗржХрзЗ ржЗржирж╕рзНржЯрж▓ ржХрж░рждрзЗ рж╣рзЯ            | `morgan`, `cors`        |
| **Error-handling**    | ржПрж░рж░ ржзрж░рждрзЗ ржУ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рждрзЗ          | `(err, req, res, next)` |

---

## ЁЯзн 5я╕ПтГг Application-Level Middleware (ржЧрзНрж▓рзЛржмрж╛рж▓ ржорж┐ржбрж▓ржУрзЯрзНржпрж╛рж░)

```js
const express = require('express');
const app = express();

// ржХрж╛рж╕рзНржЯржо рж▓ржЧрж╛рж░ middleware
function logger(req, res, next) {
  console.log(`${req.method} ${req.url}`);
  next();
}

app.use(logger); // рж╕ржм рж░рж╛ржЙржЯрзЗ ржкрзНрж░рзЯрзЛржЧ рж╣ржмрзЗ

app.get('/', (req, res) => {
  res.send('Home Page');
});

app.get('/about', (req, res) => {
  res.send('About Page');
});

app.listen(3000);
```

ЁЯза ржХржирж╕рзЛрж▓рзЗ ржжрзЗржЦрж╛ ржпрж╛ржмрзЗ:

```
GET /
GET /about
```

---

## ЁЯзн 6я╕ПтГг Router-Level Middleware

ржПржЗ Middleware рж╢рзБржзрзБ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж░рж╛ржЙржЯрж╛рж░ ржлрж╛ржЗрж▓рзЗрж░ ржоржзрзНржпрзЗ ржХрж╛ржЬ ржХрж░рзЗред

```js
// routes/admin.js
const express = require('express');
const router = express.Router();

// рж╢рзБржзрзБ admin рж░рж╛ржЙржЯрзЗрж░ ржЬржирзНржп middleware
function checkAdmin(req, res, next) {
  const isAdmin = true; // ржзрж░рж╛ ржпрж╛ржХ ржЪрзЗржХ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
  if (!isAdmin) return res.status(403).send('Forbidden');
  next();
}

router.use(checkAdmin);

router.get('/dashboard', (req, res) => {
  res.send('Welcome Admin!');
});

module.exports = router;

// main app.js
const app = express();
const adminRoutes = require('./routes/admin');
app.use('/admin', adminRoutes);
```

---

## тЪЩя╕П 7я╕ПтГг Built-in Middleware (Express ржПрж░ ржмрж┐рж▓рзНржЯ-ржЗржи ржлрж╛ржВрж╢ржи)

| Middleware                 | ржХрж╛ржЬ                                    |
| -------------------------- | -------------------------------------- |
| `express.json()`           | JSON ржбрзЗржЯрж╛ ржкрж╛рж░рзНрж╕ ржХрж░рзЗ `req.body` рждрзЗ рж░рж╛ржЦрзЗ |
| `express.urlencoded()`     | Form data ржкрж╛рж░рзНрж╕ ржХрж░рзЗ                    |
| `express.static('folder')` | Static ржлрж╛ржЗрж▓ рж╕рж╛рж░рзНржн ржХрж░рзЗ (CSS, JS, ржЗржорзЗржЬ)  |

```js
app.use(express.json());
app.use(express.static('public'));
app.use(express.urlencoded({ extended: true }));
```

---

## ЁЯз░ 8я╕ПтГг Third-Party Middleware (npm ржерзЗржХрзЗ ржЗржирзНрж╕ржЯрж▓ ржХрж░рж╛)

| Middleware        | ржХрж╛ржЬ               |
| ----------------- | ----------------- |
| `morgan`          | рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж▓ржЧ рж░рж╛ржЦрзЗ |
| `cors`            | CORS рж╕ржХрзНрж░рж┐рзЯ ржХрж░рзЗ   |
| `cookie-parser`   | ржХрзБржХрж┐ ржкрж╛рж░рзНрж╕ ржХрж░рзЗ    |
| `express-session` | рж╕рзЗрж╢ржи ржорзНржпрж╛ржирзЗржЬ ржХрж░рзЗ  |
| `helmet`          | ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржмрж╛рзЬрж╛рзЯ   |

```bash
npm install morgan cors
```

```js
const morgan = require('morgan');
const cors = require('cors');

app.use(morgan('dev'));
app.use(cors());
```

---

## тЪая╕П 9я╕ПтГг Error-Handling Middleware

ржПрж░рж░ ржзрж░рждрзЗ ржПржмржВ рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛ржарж╛рждрзЗ ржмрзНржпржмрж╣рзГржд рж╣рзЯред

> ржПржЗ Middleware-ржП ржЕржмрж╢рзНржпржЗ рзкржЯрж╛ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ ржерж╛ржХрждрзЗ рж╣ржмрзЗ: `(err, req, res, next)`

```js
function errorHandler(err, req, res, next) {
  console.error(err.message);
  res.status(500).json({ error: 'Something went wrong!' });
}

app.use(errorHandler);
```

ржпржжрж┐ ржХрзЛржирзЛ рж░рж╛ржЙржЯрзЗ ржПрж░рж░ рж╣рзЯ:

```js
app.get('/crash', (req, res, next) => {
  try {
    throw new Error('Server broke!');
  } catch (err) {
    next(err); // errorHandler ржП ржпрж╛ржмрзЗ
  }
});
```

---

## ЁЯФБ ЁЯФЯ Middleware ржПрж░ ржХрж╛ржЬрзЗрж░ ржзрж╛рж░рж╛ (Order ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг)

Express ржПржХрзЗ ржПржХрзЗ Middleware ржЪрж╛рж▓рж╛рзЯ тАФ ржпрзЗржнрж╛ржмрзЗ рждрзБржорж┐ рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░ ржХрж░рзЛред

```js
app.use(first);
app.use(second);
app.get('/', (req, res) => res.send('done!'));
```

тЮбя╕П Execution order:

```
first тЖТ second тЖТ route handler
```

ЁЯСЙ ржпржжрж┐ `first` ржП `next()` ржирж╛ ржбрж╛ржХрж╛ рж╣рзЯ, рждрж╛рж╣рж▓рзЗ ржмрж╛ржХрж┐ржЧрзБрж▓рзЛ ржЪрж▓ржмрзЗ ржирж╛ред

---

## ЁЯза 11я╕ПтГг ржмрж╛рж╕рзНрждржм ржЬрзАржмржирзЗрж░ Middleware ржмрзНржпржмрж╣рж╛рж░

| ржмрзНржпржмрж╣рж╛рж░             | ржЙржжрзНржжрзЗрж╢рзНржп                                 |
| ------------------- | ---------------------------------------- |
| **Logging**         | ржХрзЗ ржХрзЛржи рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж┐рзЯрзЗржЫрзЗ рждрж╛ рж░рзЗржХрж░рзНржб рж░рж╛ржЦрж╛ |
| **Authentication**  | рж▓ржЧржЗржи ржмрж╛ ржЯрзЛржХрзЗржи ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛                  |
| **Data Validation** | ржбрзЗржЯрж╛ рж╕ржарж┐ржХ ржХрж┐ ржирж╛ ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛                |
| **Security**        | ржирж┐рж░рж╛ржкрждрзНрждрж╛ рж╣рзЗржбрж╛рж░ ржпрзБржХрзНржд ржХрж░рж╛                |
| **Compression**     | рж░рзЗрж╕ржкржирзНрж╕ рж╕рж╛ржЗржЬ ржЫрзЛржЯ ржХрж░рж╛                     |
| **Error Tracking**  | ржПрж░рж░ ржХрзНржпрж╛ржЪ ржХрж░рзЗ рж░рж┐ржкрзЛрж░рзНржЯ ржХрж░рж╛                |

---

## ЁЯТб 12я╕ПтГг ржПржХрж╛ржзрж┐ржХ Middleware ржПржХрж╕рж╛ржерзЗ ржмрзНржпржмрж╣рж╛рж░

```js
function auth(req, res, next) {
  if (!req.headers.token) return res.status(401).send('Unauthorized');
  next();
}

function logRequest(req, res, next) {
  console.log(`${req.method} - ${req.url}`);
  next();
}

app.use(logRequest); // рж╕ржм рж░рж╛ржЙржЯрзЗ
app.get('/private', auth, (req, res) => res.send('Welcome authorized user!'));
```

ЁЯФ╕ ржПржЦрж╛ржирзЗ:

* `logRequest` рж╕ржм рж░рж╛ржЙржЯрзЗ ржЪрж▓ржмрзЗ
* `auth` рж╢рзБржзрзБ `/private` рж░рж╛ржЙржЯрзЗ ржЪрж▓ржмрзЗ

---

## тЪб 13я╕ПтГг Async Middleware Example (Promise / async-await рж╕рж╣)

```js
app.use(async (req, res, next) => {
  try {
    const user = await getUserFromDB();
    req.user = user;
    next();
  } catch (err) {
    next(err); // Error Handler ржП ржпрж╛ржмрзЗ
  }
});
```

---

## ЁЯз╛ 14я╕ПтГг Middleware рж▓рзЗржЦрж╛рж░ ржХрж┐ржЫрзБ ржнрж╛рж▓рзЛ ржЕржнрзНржпрж╛рж╕ (Best Practices)

тЬЕ рж╕ржмрж╕ржорзЯ `next()` ржХрж▓ ржХрж░рзЛ, ржпржжрж┐ рж░рзЗрж╕ржкржирзНрж╕ ржирж╛ ржкрж╛ржарж╛ржУред
тЬЕ ржкрзНрж░рждрж┐ржЯрж┐ Middleware-ржХрзЗ ржПржХржЯрж╛ржЗ ржХрж╛ржЬрзЗрж░ ржЬржирзНржп ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ (Single Responsibility)ред
тЬЕ Middleware-ржПрж░ ржХрзНрж░ржо ржарж┐ржХ рж░рж╛ржЦрзЛ (Order matters)ред
тЬЕ ржПрж░рж░ Middleware рж╕ржмрж╢рзЗрж╖рзЗ рж░рж╛ржЦрзЛред
тЬЕ Event loop ржмрзНрж▓ржХ ржХрзЛрж░рзЛ ржирж╛, async I/O ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛред
тЬЕ ржкрзБржирж░рзНржмрзНржпржмрж╣рж╛рж░ржпрзЛржЧрзНржп ржУ ржкрж░рж┐рж╖рзНржХрж╛рж░ ржХрзЛржб рж▓рж┐ржЦрзЛред

---

## ЁЯФН 15я╕ПтГг рж╕рж╛рж░рж╛ржВрж╢ (Quick Revision)

| ржмрж┐рж╖рзЯ          | рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк                                   |
| ------------- | -------------------------------------------- |
| Middleware    | Request ржУ Response-ржПрж░ ржорж╛ржЭрзЗ ржХрж╛ржЬ ржХрж░рзЗ ржПржоржи ржлрж╛ржВрж╢ржи |
| Arguments     | `(req, res, next)`                           |
| Built-in      | `express.json()`, `express.static()`         |
| Custom        | `app.use(myFunction)`                        |
| Error Handler | `(err, req, res, next)`                      |
| Order         | ржЙржкрж░рзЗрж░ ржжрж┐ржХ ржерзЗржХрзЗ ржирж┐ржЪрзЗрж░ ржжрж┐ржХрзЗ                    |
| Use Cases     | Logging, Auth, Validation, Security ржЗрждрзНржпрж╛ржжрж┐  |

---
